\documentclass{article}
\usepackage{ifxetex}
\usepackage{fancyhdr}
\usepackage{background}
\usepackage{graphicx}
\usepackage{svg}
\usepackage{xstring}
\usepackage[paperheight=8.89cm,paperwidth=6.35cm,margin=0.6cm,top=19.5mm,bottom=7.5mm,headheight=1cm]{geometry}

\backgroundsetup{
    contents={\includegraphics[width=\paperwidth,height=\paperheight]{../images/backgrounds/background1}},
    scale=1,
    angle=0,
    opacity=1
    }

\usepackage{fontspec}
\setmainfont{CrimsonPro-Medium.ttf}[
  Path = ../fonts/,
  BoldFont = CrimsonPro-Bold.ttf,
  ItalicFont = CrimsonPro-MediumItalic.ttf
]

% Create fake small caps command for CrimsonPro with larger first letter
\usepackage{xparse}
\NewDocumentCommand{\fakesc}{m}{%
  \StrLeft{#1}{1}[\firstletter]%
  \StrGobbleLeft{#1}{1}[\restoftext]%
  {\addfontfeature{LetterSpace=5.0}\MakeUppercase{\firstletter}\scalebox{0.8}[0.8]{\MakeUppercase{\restoftext}}}%
}

\newcommand{\boldfont}{\bfseries}
\newcommand{\italicfont}{\upshape\itshape}
\newcommand{\bolditalicfont}{\upshape\bfseries\itshape}
\newcommand{\scitalicfont}{\scshape\itshape}


\renewcommand{\scriptsize}{\fontsize{7.5}{9}\selectfont}

\definecolor{headercolor}{RGB}{88,23,13}
\definecolor{linecolor}{RGB}{201,173,106}

\sloppy
\setlength{\headsep}{3mm}
\pagestyle{fancy}
\chead{\scriptsize{\spellheader}\\[-1.8mm]\Large\color{headercolor}\fakesc{\spelltitle}\ifnum\pdfstrcmp{\concentration}{CONCENTRATION}=0\hspace{1mm}\includesvg[width=0.2cm]{../images/concentration}\fi}
\cfoot{\if\relax\spellsource\relax\else\scriptsize\color{headercolor}\itshape\spellsource\fi}
\setlength{\parindent}{0pt}

% Helper command to add closing parenthesis if needed
\newcommand{\addclosingparen}[1]{%
    \ifx#1\empty%
    \else%
        \StrBefore{#1}{(}[\beforeparen]%
        \StrBehind{#1}{(}[\afterparen]%
        \ifx\beforeparen#1%
            % No opening parenthesis found
        \else%
            {\italicfont )}%
        \fi%
    \fi%
}


% Command to display range with area effect icons if applicable
\newcommand{\displayrange}[1]{%
    \ifx\relax#1\relax%
        \relax%
    \else%
        \StrBefore{#1}{|}[\rangetext]%
        \StrBehind{#1}{|}[\remaining]%
        \StrBefore{\remaining}{|}[\showcubeicon]%
        \StrBehind{\remaining}{|}[\showemanationicon]%
        % Check for cube icon
        \ifnum\pdfstrcmp{\showcubeicon}{True}=0%
            {\italicfont\rangetext}\hspace{0.5mm}\includesvg[width=0.15cm]{../images/areas_effect/cube}%
            \addclosingparen{\rangetext}%
        \else%
            % Check for emanation icon
            \ifnum\pdfstrcmp{\showemanationicon}{True}=0%
                {\italicfont\rangetext}\hspace{0.5mm}\includesvg[width=0.15cm]{../images/areas_effect/emanation}%
                \addclosingparen{\rangetext}%
            \else%
                % No icon
                {\italicfont\rangetext}%
            \fi%
        \fi%
    \fi%
}


\newenvironment{spell}[9]{
    \def\spelltitle{#1}
    \def\spellheader{#2}
    \def\castrange{#3}
    \def\casttime{#4}
    \def\duration{#5}
    \def\components{#6}
    \def\spellsource{#7}
    \def\attacksave{#8}
    \def\damageeffect{#9}
    
    % Parse concentration flag from duration
    \StrBefore{\duration}{|}[\durationtext]
    \StrBehind{\duration}{|}[\concentrationflag]
    \def\concentration{\concentrationflag}
    \begin{minipage}[t][5cm][t]{\textwidth}
    \vspace{-1.2em}
    \setlength{\parskip}{0.5em}
    \begin{minipage}[t]{0.32\textwidth}
        \centering\footnotesize{\color{headercolor}\fakesc{Casting time}}

        {\italicfont\casttime}
	\end{minipage}
    \begin{minipage}[t]{0.32\textwidth}
        \centering\footnotesize{\color{headercolor}\fakesc{Range}}

        \displayrange{\castrange}
	\end{minipage}
    \begin{minipage}[t]{0.32\textwidth}
        \centering\footnotesize{\color{headercolor}\fakesc{Components}}

        {\italicfont\components}
	\end{minipage}\\[3mm]
    \begin{minipage}[t]{0.32\textwidth}
        \centering\footnotesize{\color{headercolor}\fakesc{Duration}}

        \ifnum\pdfstrcmp{\concentration}{CONCENTRATION}=0\includesvg[width=0.15cm]{../images/concentration}\hspace{0.5mm}\fi{\italicfont\durationtext}
	\end{minipage}
    \begin{minipage}[t]{0.32\textwidth}
        \centering\footnotesize{\color{headercolor}\fakesc{Attack/Save}}

        {\italicfont\attacksave}
	\end{minipage}
    \begin{minipage}[t]{0.32\textwidth}
        \centering\footnotesize{\color{headercolor}\fakesc{Damage/Effect}}

        {\italicfont\damageeffect}
	\end{minipage}
    \vspace{-0.55em}
    % Fancy divider using custom SVG
    \begin{center}
        \includesvg[width=0.95\textwidth]{../images/dividers/divider1}
    \end{center}
    \vspace{-1em}
    \scriptsize
}{
    \end{minipage}
    \newpage
}

\begin{document}
\input{spells}
\end{document}
