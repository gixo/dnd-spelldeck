\documentclass{article}
\usepackage{ifxetex}
\usepackage{fancyhdr}
\usepackage{background}
\usepackage{graphicx}
\usepackage{svg}
\usepackage{xstring}
\usepackage[paperheight=8.89cm,paperwidth=6.35cm,margin=0.3cm,top=20mm,bottom=0mm,headheight=25mm]{geometry}

% Debug packages - comment out when not needed
 %\usepackage{showframe}  % Shows page margins and frames
 %\usepackage{layout}      % Shows layout parameters
 %\overfullrule=5pt        % Shows overfull hboxes with black bars
% To show minipage boxes, wrap them with \fbox{} temporarily
% Example: \fbox{\begin{minipage}...\end{minipage}}
% Or set a colored frame globally:
 %\setlength{\fboxsep}{0pt}  % Remove padding
 %\setlength{\fboxrule}{0.4pt}  % Thin border

\backgroundsetup{
    contents={\includegraphics[width=\paperwidth,height=\paperheight]{../images/backgrounds/background1}},
    scale=1,
    angle=0,
    opacity=1
    }

\usepackage{fontspec}
\setmainfont{CrimsonPro-Medium.ttf}[
  Path = ../fonts/,
  BoldFont = CrimsonPro-Bold.ttf,
  ItalicFont = CrimsonPro-MediumItalic.ttf
]

% Create fake small caps command that preserves original casing
% Expand the argument first so macro inputs (e.g. \spelltitle) are handled
\newcommand\fauxsc[1]{%
  \begingroup
  \edef\fauxsctemp{\noexpand\fauxschelper#1 \relax\relax}%
  \fauxsctemp
  \endgroup
}
\def\fauxschelper#1 #2\relax{%
  \fauxschelphelp#1\relax\relax%
  \if\relax#2\relax\else\ \fauxschelper#2\relax\fi%
}
\def\Hscale{.85}\def\Vscale{.75}\def\Cscale{1.00}
\def\fauxschelphelp#1#2\relax{%
  \ifnum`#1=\lccode`#1\relax\scalebox{\Hscale}[\Vscale]{\char\uccode`#1}\else%
    \scalebox{\Cscale}[1]{#1}\fi%
  \ifx\relax#2\relax\else\fauxschelphelp#2\relax\fi}

\newcommand{\boldfont}{\bfseries}
\newcommand{\italicfont}{\upshape\itshape}
\newcommand{\bolditalicfont}{\upshape\bfseries\itshape}
\newcommand{\scitalicfont}{\scshape\itshape}


\renewcommand{\scriptsize}{\fontsize{7}{9}\selectfont}
\renewcommand{\footnotesize}{\fontsize{7.5}{9}\selectfont}

\definecolor{headercolor}{RGB}{88,23,13}
\definecolor{linecolor}{RGB}{201,173,106}

\sloppy
\setlength{\headsep}{0mm}  % Space between header and main content
\setlength{\footskip}{5mm}  % Distance from bottom of text to baseline of footer
\pagestyle{fancy}
\chead{\scriptsize{\spellheader}\\[-1.8mm]\Large\color{headercolor}\fauxsc{\spelltitle}\ifnum\pdfstrcmp{\concentration}{CONCENTRATION}=0\hspace{1mm}\includesvg[width=0.2cm, height=0.2cm, keepaspectratio]{../images/concentration}\fi\ifnum\pdfstrcmp{\ritualcastflag}{RITUAL}=0\hspace{1mm}\includesvg[width=0.2cm, height=0.2cm, keepaspectratio]{../images/ritual}\fi}
\cfoot{\if\relax\spellsource\relax\else\scriptsize\color{headercolor}\itshape\spellsource\fi}
\setlength{\parindent}{0pt}

% Helper command to add closing parenthesis if needed
\newcommand{\addclosingparen}[1]{%
    \ifx#1\empty%
    \else%
        \StrBefore{#1}{(}[\beforeparen]%
        \StrBehind{#1}{(}[\afterparen]%
        \ifx\beforeparen#1%
            % No opening parenthesis found
        \else%
            {\italicfont )}%
        \fi%
    \fi%
}


% Command to display range with area effect icons if applicable
\newcommand{\displayrange}[1]{%
    \ifx\relax#1\relax%
        \relax%
    \else%
        \StrBefore{#1}{|}[\rangetext]%
        \StrBehind{#1}{|}[\areaeffect]%
        % Check if there's an area effect (not "none")
        \ifnum\pdfstrcmp{\areaeffect}{none}=0%
            % No area effect icon
            {\italicfont\rangetext}%
        \else%
            % Show area effect icon
            {\italicfont\rangetext}\hspace{0.5mm}\includesvg[width=0.15cm]{../images/areas_effect/\areaeffect}%
            \addclosingparen{\rangetext}%
        \fi%
    \fi%
}


\newenvironment{spell}[9]{
    \def\spelltitle{#1}
    \def\spellheader{#2}
    \def\castrange{#3}
    \def\casttime{#4}
    \def\duration{#5}
    \def\components{#6}
    \def\spellsource{#7}
    \def\attacksave{#8}
    \def\damageeffect{#9}

    % Parse ritual flag from casting time
    \StrBefore{\casttime}{|}[\casttimetext]
    \StrBehind{\casttime}{|}[\ritualcastflag]

    % Parse concentration flag from duration
    \StrBefore{\duration}{|}[\durationtext]
    \StrBehind{\duration}{|}[\concentrationflag]
    \def\concentration{\concentrationflag}

    \begin{minipage}[t][5.7cm][t]{\textwidth}  % Main content height
        \setlength{\parskip}{0.5em}%
        \vspace{-0.2em}
        % Spell attributes section
        \begin{minipage}[t]{\textwidth}
            \begin{minipage}[t]{0.32\textwidth}
                \centering\footnotesize{\color{headercolor}\fauxsc{Casting Time}}

                {\italicfont\casttimetext} \ifnum\pdfstrcmp{\ritualcastflag}{RITUAL}=0\includesvg[width=0.15cm, height=0.15cm, keepaspectratio]{../images/ritual}\hspace{0.5mm}\fi
            \end{minipage}
            \begin{minipage}[t]{0.32\textwidth}
                \centering\footnotesize{\color{headercolor}\fauxsc{Range}}

                \displayrange{\castrange}
            \end{minipage}
            \begin{minipage}[t]{0.32\textwidth}
                \centering\footnotesize{\color{headercolor}\fauxsc{Duration}}

                \ifnum\pdfstrcmp{\concentration}{CONCENTRATION}=0\includesvg[width=0.15cm, height=0.15cm, keepaspectratio]{../images/concentration}\hspace{0.5mm}\fi{\italicfont\durationtext}
            \end{minipage}
        \end{minipage}

        % Second row of attributes
        \leavevmode
        \begin{minipage}[t]{\textwidth}
            \begin{minipage}[t]{0.32\textwidth}
                \centering\footnotesize{\color{headercolor}\fauxsc{Attack/Save}}

                {\italicfont\attacksave}
            \end{minipage}
            \begin{minipage}[t]{0.32\textwidth}
                \centering\footnotesize{\color{headercolor}\fauxsc{Damage/Effect}}

                {\italicfont\damageeffect}
            \end{minipage}
            \begin{minipage}[t]{0.32\textwidth}
                \vspace{0.1em} %ensures duration is aligned with other attributes
                \centering\footnotesize{\color{headercolor}\fauxsc{Components}}

                {\italicfont\components}
            \end{minipage}
            \vspace{0.9em}
        \end{minipage}
        % Fancy divider using custom SVG
        \vspace{0em}
        \includesvg[width=0.75\textwidth]{../images/dividers/divider1}
        \vspace{0.1em}
        % Spell description section
        \centering
        \vspace{0em}
        \begin{minipage}[t]{0.9\textwidth}
            \vspace{-0.35em}
            \setlength{\parskip}{0.2em}
            \scriptsize
            % set line height to 1.2
            \setlength{\baselineskip}{1.15em}
}{
        \end{minipage}
    \end{minipage}
    \newpage
}

\begin{document}
\input{spells}
\end{document}
